<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>ChatGPT</title>
  <link rel="stylesheet" href="index.css" />
</head>

<body class="myarrow">
  <div class="close-button"></div>
  <tab-group new-tab-button="true" sortable="true">
    <style>
      .views {
        background-color: rgb(46, 47, 57);
      }

      .nav {
        -webkit-app-region: drag;
      }

      .nav button,
      .tabs {
        -webkit-app-region: no-drag;
      }
    </style>
  </tab-group>
  <script src="node_modules/electron-tabs/dist/electron-tabs.js"></script>
  <script>
    const tabGroup = document.querySelector("tab-group");
    const tab = tabGroup.addTab({
      title: "GPT",
      src: "https://chat.openai.com/chat",
      active: true,
    });
    tabGroup.setDefaultTab({
      title: "New GPT",
      src: "https://chat.openai.com/chat",
      active: true
    });

    window.electronAPI.onNewTabShortcut((_event) => {
      const tab = tabGroup.addTab({
        title: "GPT",
        src: "https://chat.openai.com/chat",
        active: true,
      });
    });

    window.electronAPI.onCloseTabShortcut((_event) => {
      const activeTab = tabGroup.getActiveTab();
      activeTab.close();
    });

    window.electronAPI.onNextTabShortcut((_event) => {
      let nextTab = tabGroup.getTabByRelPosition(1);
      if (nextTab === null) {
        nextTab = tabGroup.getTabByPosition(-1);
      }
      nextTab.activate();
    });

    window.electronAPI.onPrevTabShortcut((_event) => {
      let prevTab = tabGroup.getTabByRelPosition(-1);
      if (prevTab === null) {
        prevTab = tabGroup.getTabByPosition(0);
      }
      prevTab.activate();
    });
  </script>
  <script>
    const focusIframeAndTextbox = function () {
      setTimeout(function () {
        const tabGroupShadowRoot = tabGroup.shadowRoot;
        const activeWebview = tabGroupShadowRoot.querySelector('webview.view.visible');
        const webviewShadowRoot = activeWebview.shadowRoot;
        const iframe = webviewShadowRoot.querySelector('iframe');
        iframe.focus(); // this needs to get focused instead of the webview for the textarea to get properly focused!

        activeWebview.executeJavaScript(`
          setTimeout(function() {
            const randomNumber = Math.floor(Math.random() * 1000000);
            const textarea = document.querySelector('textarea');
            textarea.placeholder = 'Auto focused this textbox: ' + randomNumber;
            textarea.focus();
          }, 100);
        `);
      }, 100)
    }

    tabGroup.on("tab-active", (tab, tabGroup) => {
      focusIframeAndTextbox();
    });

    window.electronAPI.onFocusTextbox((_event) => {
      focusIframeAndTextbox();
    })

    // Add event listener to close button
    const closeButton = document.querySelector(".close-button");
    closeButton.addEventListener("click", () => {
      window.close();
    });

    // TODO: in this JS code, create the close button in js, access the shadow dom and insert it when web content has loaded (in the event listener). Style it so that it is stored in the nav component
  </script>

</body>

</html>